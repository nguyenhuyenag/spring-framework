<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Home</title>
    <meta charset="UTF-8">
    <link rel="shortcut icon" href="#">
    <!-- ===== JS ===== -->
    <script th:src="@{/script/jquery-3.7.1.slim.min.js}"></script>
    <script th:src="@{/script/bootstrap.min.js}"></script>
    <script defer th:src="@{/script/alpinejs-3.15.0.js}"></script>
    <!-- ===== CSS ===== -->
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
</head>

<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-4">
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <h5 class="card-title text-center mb-4">Enter Your Email</h5>
                        <!-- Form -->
                        <form th:action="@{/form-submit}" method="post" id="emailForm">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email address</label>
                                <input type="email" class="form-control" id="email" name="email" 
                                    value="" placeholder="name@example.com" required>
                            </div>
                            <div class="d-grid gap-2 text-center">
                                <button type="submit" class="btn btn-primary">Submit (Form)</button>
                                <button type="button" id="btnFetchPost" class="btn btn-secondary">Submit (Fetch POST)</button>
                                <button type="button" id="btnFetchGet" class="btn btn-info text-white">Submit (Fetch GET param)</button>
                            </div>
                        </form>
                        <!-- ===== Th√¥ng b√°o c·ªßa Form Submit ===== -->
                        <div th:if="${message}" class="alert alert-success text-center mt-3" role="alert"
                            id="formMessage">
                            <p th:text="${message}"></p>
                            <p>Email: <span th:text="${email}"></span></p>
                        </div>
                        <!-- ===== Th√¥ng b√°o c·ªßa Fetch() ===== -->
                        <div id="fetchMessage" class="alert text-center mt-3 d-none" role="alert"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
    const fetchMsg = document.getElementById('fetchMessage');
    
    const btnPost = document.getElementById('btnFetchPost');
    const btnGet = document.getElementById('btnFetchGet');

    // Form submit
    const form = document.querySelector('form');
    form.addEventListener('submit', (e) => {
        console.log("üöÄ Form submit triggered");
        const email = document.getElementById('email').value;
        console.log("üìß Email trong form submit:", email);
    });

    // Submit (Fetch POST)
    btnPost.addEventListener('click', async () => {
        const email = document.getElementById('email').value;

        console.log("üü° [POST] B·∫Øt ƒë·∫ßu g·ª≠i fetch...", email);

        try {
            const response = await fetch('/form-submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
                body: new URLSearchParams({ email })
            });

            console.log("üü¢ [POST] Nh·∫≠n ph·∫£n h·ªìi fetch");

            if (!response.ok) throw new Error('Request failed: ' + response.status);
            showMessage(`‚úÖ G·ª≠i b·∫±ng fetch(POST) th√†nh c√¥ng!`, email, true);
        } catch (err) {
            console.error("üî¥ [POST] L·ªói fetch:", err);
            showMessage(`‚ùå L·ªói khi g·ª≠i b·∫±ng fetch(POST): ${err.message}`, '', false);
        }

        console.log("‚ö™ [POST] K·∫øt th√∫c x·ª≠ l√Ω s·ª± ki·ªán click");
    });

    // Submit (Fetch GET param)
    btnGet.addEventListener('click', async () => {
        const emailInput = document.getElementById('email');
        const email = emailInput.value.trim();

        console.log("üü° [GET] Click n√∫t fetch GET, email:", email);

        // üß† Hi·ªÉn th·ªã popup l·ªói n·∫øu form ch∆∞a h·ª£p l·ªá
        if (!form.reportValidity()) {
            console.warn("‚ö†Ô∏è [GET] Form ch∆∞a h·ª£p l·ªá ‚Äî d·ª´ng g·ª≠i request");
            return;
        }

        const url = `/form-submit-get?email=${encodeURIComponent(email)}`;
        console.log("üü° [GET] Chu·∫©n b·ªã g·ª≠i request ƒë·∫øn:", url);

        try {
            const response = await fetch(url);
            console.log("üü¢ [GET] Nh·∫≠n ph·∫£n h·ªìi fetch");

            if (!response.ok) throw new Error('Request failed: ' + response.status);
            showMessage(`‚úÖ G·ª≠i b·∫±ng fetch(GET param) th√†nh c√¥ng!`, email, true);
        } catch (err) {
            console.error("üî¥ [GET] L·ªói fetch:", err);
            showMessage(`‚ùå L·ªói khi g·ª≠i b·∫±ng fetch(GET param): ${err.message}`, '', false);
        }

        console.log("‚ö™ [GET] K·∫øt th√∫c x·ª≠ l√Ω s·ª± ki·ªán click");
    });

    function showMessage(msg, email, success) {
        fetchMsg.classList.remove('d-none', 'alert-success', 'alert-danger');
        fetchMsg.classList.add(success ? 'alert-success' : 'alert-danger');
        fetchMsg.innerHTML = `<p>${msg}</p>${email ? `<p>Email: ${email}</p>` : ''}`;
    }
});

    </script>
</body>

</html>
